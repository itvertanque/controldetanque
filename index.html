<!DOCTYPE html> 
<html> 
  <head> 
  <meta charset="UTF-8">
  <title>Control de Tanque WiFi</title>
  <script src='mqttws31.js' type='text/javascript'></script>
  <script src="raphael-2.1.4.min.js"></script>
  <link rel="stylesheet" type="text/css" href="range.css">
  <script src="justgage.js"></script> 
  <script src="jquery.js"></script>
  <link rel="icon" type="image/png" href="itver.png" /> 
 </head> 

<body> 
<center>

<table border="0">
      <tr>
      <td><center>

  <a><img src="titu.png" alt=""></a>
  <div id="txtcheck">ACTIVAR</div>
  <label class="switch3">
  <input type="checkbox" id="botontest" onclick='OnOff3()'>
  <span class="slider round3"></span>
  </label>
  <div id="gauge" class="a200x160px"></div>
  <div><img id="imgEstado" src="petrol.png"></div>
  <div><a id="estado">Normal</a></div>
  <a id="br2"><br><br></a>
  <a id="logoitv"><img src="itver.png" alt=""></a>
  <a id="br3"><br><br><br></a>   
</center>
</td>     
</tr>  
    </table>
    <a  id= "br1"><br><br><br><br></a>
    <div id="dimi">Programacion Avanzada</div><br>
  <a  id= "br4"><br><br><br></a>
  </center>

</body>
</html>


<script type="text/javascript">

usuario = 'proyectos';
contrasena = '123456789';

var g = new JustGage({
id: "gauge",
min: 0,
max: 100,
title: "NIVEL"});

check="OFF";
nivel=0;
strEstado=" ";
strEstadoUltimo=" ";
$("#gauge").hide();
$("#imgEstado").hide();
$("#estado").hide();
$("#br1").show();
$("#br2").show();
$("#br3").show();
$("#br4").hide();
$("#logoitv").show();
$("#dimi").show();




    function OnOff3(){
        if (check == "OFF"){
          message = new Paho.MQTT.Message("ON");
          message.destinationName = '/' + usuario + '/check'
          client.send(message);
      }
        else if (check == "ON"){
          message = new Paho.MQTT.Message("OFF");
          message.destinationName = '/' + usuario + '/check'
          client.send(message);
      }
         
         };  


    function onConnect() {
        // Once a connection has been made, make a subscription and send a message.
        console.log("onConnect");
        client.subscribe("#");
      }
        
      // called when the client loses its connection
    function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
          console.log("onConnectionLost:", responseObject.errorMessage);
          setTimeout(function() { client.connect() }, 5000);
        }
      }
      // called when a message arrives
      function onMessageArrived(message) {
        if (message.destinationName == '/' + usuario + '/' + 'nivel') { 
       g.refresh(message.payloadString);
       nivel= parseInt(message.payloadString);
       
          if (nivel <= 0) {
            strEstado = "Vacio";
          }
          if(nivel >0 && nivel<100) {
            strEstado = "Normal";
          }
          if(nivel >=100) {
            strEstado = "Lleno";
          }
       if (strEstado != strEstadoUltimo) { //envia el estado solamente cuando cambia.
          strEstadoUltimo = strEstado;
          document.getElementById("estado").textContent = strEstado;
             if (strEstado == "Lleno"){
              document.getElementById("imgEstado").src = "petrolf.png"
              estadoautomatico = "ON";}
            if (strEstado == "Normal"){
              document.getElementById("imgEstado").src = "petrol.png"}
            if (strEstado == "Vacio"){
              document.getElementById("imgEstado").src = "petrole.png"
              estadoautomatico = "OFF";}           
            }
                                        }

      if (message.destinationName == '/' + usuario + '/' + 'check') { 
           check = message.payloadString;
           if (check == "ON") {
              document.getElementById("botontest").checked=true;
              document.getElementById("txtcheck").textContent = "DESACTIVAR";
              $("#gauge").show();
              $("#estado").show();
              $("#imgEstado").show();
              $("#br1").hide();
              $("#br2").hide();
              $("#br3").hide();
              $("#br4").hide();
              $("#logoitv").hide();
              $("#dimi").hide();
            
            }
            else if (check == "OFF") {
              document.getElementById("estado").textContent ="Normal";
              document.getElementById("botontest").checked=false;
              document.getElementById("txtcheck").textContent = "ACTIVAR";
              document.getElementById("imgEstado").src = "petrol.png"
              document.getElementById("estado").style.color="black";

              check="OFF";
              nivel=0;
              strEstado=" ";
              strEstadoUltimo=" ";
              $("#gauge").hide();
              $("#estado").hide();
              $("#imgEstado").hide();
              $("#br1").show();
              $("#br2").show();
              $("#br3").show();
              $("#br4").hide();
              $("#logoitv").show();
              $("#dimi").show();
            }
          }

      }
        function onFailure(invocationContext, errorCode, errorMessage) {
          var errDiv = document.getElementById("error");
          errDiv.textContent = "Could not connect to WebSocket server, most likely you're behind a firewall that doesn't allow outgoing connections to port 36163";
          errDiv.style.display = "block";
        }
        
        var clientId = "ws" + Math.random();
        // Create a client instance
        var client = new Paho.MQTT.Client("tailor.cloudmqtt.com", 	35723, clientId);
        
        // set callback handlers
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;
        
        // connect the client
        client.connect({
          useSSL: true,
          userName: usuario,
          password: contrasena,
          onSuccess: onConnect,
          onFailure: onFailure
        });
</script>
